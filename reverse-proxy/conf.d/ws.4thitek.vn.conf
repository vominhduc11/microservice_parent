# WebSocket Service - ws.4thitek.vn
# Direct connection to notification-service (not through API Gateway)

server {
    listen 80;
    server_name ws.4thitek.vn;

    # Redirect HTTP to HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name ws.4thitek.vn;

    # SSL certificates
    ssl_certificate /etc/nginx/ssl/4thitek.vn/fullchain.pem;
    ssl_certificate_key /etc/nginx/ssl/4thitek.vn/privkey.pem;

    # Security headers (minimal for WebSocket)
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # Rate limiting for WebSocket connections
    limit_req zone=general burst=50 nodelay;
    limit_conn addr 50;  # Allow more concurrent connections for WebSocket

    # WebSocket endpoint
    location /ws {
        # Proxy to notification-service directly
        proxy_pass http://notification-service:8087/ws;

        # Essential WebSocket headers
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;

        # Standard proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;

        # WebSocket timeouts - keep connection alive
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
        proxy_connect_timeout 75s;

        # Disable buffering for WebSocket
        proxy_buffering off;

        # Keep connection open
        proxy_request_buffering off;
    }

    # SockJS info endpoint
    location /ws/info {
        proxy_pass http://notification-service:8087/ws/info;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # SockJS transport endpoints
    location ~* /ws/[0-9]+/[a-z0-9]+/(xhr|websocket|eventsource|htmlfile) {
        proxy_pass http://notification-service:8087;
        proxy_http_version 1.1;

        # WebSocket upgrade
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Long-lived connection timeouts
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;

        # Disable buffering
        proxy_buffering off;
        proxy_request_buffering off;
    }

    # Health check
    location /health {
        access_log off;
        return 200 "WebSocket Proxy OK";
        add_header Content-Type text/plain;
    }
}
